<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mystery Stays Frontend</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; margin: 0; padding: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
        h1 { text-align: center; color: #2c3e50; }
        h2 { margin-top: 32px; color: #34495e; }
        form { margin-bottom: 24px; }
        label { display: block; margin: 12px 0 4px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background: #007bff; color: #fff; border: none; padding: 10px 24px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background: #0056b3; }
        .result { background: #f0f8ff; border-left: 4px solid #007bff; margin: 12px 0 24px; padding: 12px; border-radius: 4px; }
        .section { margin-bottom: 36px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mystery Stays</h1>

        <div class="section">
            <h2>One-Click Demo</h2>
            <button id="oneClickDemoBtn">Run Full Demo</button>
            <div id="oneClickDemoResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Scan Airbnb for Mystery Stays</h2>
            <form id="scanAirbnbForm">
                <label>City</label>
                <input type="text" name="city" required value="Lisbon">
                <label>Check-in</label>
                <input type="date" name="check_in" required>
                <label>Check-out</label>
                <input type="date" name="check_out" required>
                <button type="submit">Scan</button>
            </form>
            <div id="scanAirbnbResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Add Property (Host)</h2>
            <form id="addPropertyForm">
                <label>Name</label>
                <input type="text" name="name" required>
                <label>Original Price</label>
                <input type="number" name="original_price" required>
                <label>Amenities (comma separated)</label>
                <input type="text" name="amenities" required>
                <label>Bedrooms</label>
                <input type="number" name="bedrooms" required>
                <label>City</label>
                <input type="text" name="city" required>
                <label>Country</label>
                <input type="text" name="country" required>
                <button type="submit">Add Property</button>
            </form>
            <div id="addPropertyResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Register User Preferences</h2>
            <form id="registerPreferencesForm">
                <label>User ID</label>
                <input type="text" name="user_id" required>
                <label>Preferred Amenities (comma separated)</label>
                <input type="text" name="amenities" required>
                <label>Max Price</label>
                <input type="number" name="price_max" required>
                <label>Bedrooms</label>
                <input type="number" name="bedrooms" required>
                <button type="submit">Register Preferences</button>
            </form>
            <div id="registerPreferencesResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Find Matches</h2>
            <form id="findMatchesForm">
                <label>User ID</label>
                <input type="text" name="user_id" required>
                <button type="submit">Find Matches</button>
            </form>
            <div id="findMatchesResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Book Stay</h2>
            <form id="bookStayForm">
                <label>User ID</label>
                <input type="text" name="user_id" required>
                <label>Property ID</label>
                <input type="text" name="property_id" required>
                <label>Check-in Date</label>
                <input type="date" name="check_in" required>
                <label>Check-out Date</label>
                <input type="date" name="check_out" required>
                <button type="submit">Book Stay</button>
            </form>
            <div id="bookStayResult" class="result"></div>
        </div>

        <div class="section">
            <h2>Reveal Location</h2>
            <form id="revealLocationForm">
                <label>Booking ID</label>
                <input type="text" name="booking_id" required>
                <button type="submit">Reveal Location</button>
            </form>
            <div id="revealLocationResult" class="result"></div>
        </div>
    </div>
    <script>
        const BASE = "[http://127.0.0.1](http://127.0.0.1):5001";

        // Helper to display JSON nicely
        function showResult(elementId, data) {
            document.getElementById(elementId).textContent = JSON.stringify(data, null, 2);
        }

        // Scan Airbnb (placeholder for future implementation)
        document.getElementById("scanAirbnbForm").onsubmit = async function(e) {
            e.preventDefault();
            // Implement your scan logic here
            showResult("scanAirbnbResult", { message: "Scan functionality not yet implemented." });
        };

        // Add Property
        document.getElementById("addPropertyForm").onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                name: form.name.value,
                original_price: Number(form.original_price.value),
                amenities: form.amenities.value.split(',').map(a => a.trim()),
                bedrooms: Number(form.bedrooms.value),
                location: {
                    city: form.city.value,
                    country: form.country.value
                }
            };
            const resp = await fetch(`${BASE}/properties/add`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
            showResult("addPropertyResult", await resp.json());
        };

        // Register Preferences
        document.getElementById("registerPreferencesForm").onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                user_id: form.user_id.value,
                preferences: {
                    amenities: form.amenities.value.split(',').map(a => a.trim()),
                    price_max: Number(form.price_max.value),
                    bedrooms: Number(form.bedrooms.value)
                }
            };
            const resp = await fetch(`${BASE}/users/preferences`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
            showResult("registerPreferencesResult", await resp.json());
        };

        // Find Matches
        document.getElementById("findMatchesForm").onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.user_id.value;
            const resp = await fetch(`${BASE}/properties/match/${userId}`);
            showResult("findMatchesResult", await resp.json());
        };

        // Book Stay
        document.getElementById("bookStayForm").onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                user_id: form.user_id.value,
                property_id: form.property_id.value,
                check_in: form.check_in.value,
                check_out: form.check_out.value
            };
            const resp = await fetch(`${BASE}/bookings/create`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });
            showResult("bookStayResult", await resp.json());
        };

        // Reveal Location
        document.getElementById("revealLocationForm").onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const bookingId = form.booking_id.value;
            const resp = await fetch(`${BASE}/bookings/reveal/${bookingId}`);
            showResult("revealLocationResult", await resp.json());
        };

        // --- One-Click Demo Logic ---
        document.getElementById("oneClickDemoBtn").onclick = async function() {
            const resultDiv = document.getElementById("oneClickDemoResult");
            resultDiv.textContent = "Running demo...";

            // Step 1: Generate random property
            const propertyNames = ["Sunny Loft", "Cozy Studio", "Urban Retreat", "Seaside Escape", "Mountain Cabin"];
            const cities = ["Lisbon", "Barcelona", "Berlin", "Paris", "Athens"];
            const countries = ["Portugal", "Spain", "Germany", "France", "Greece"];
            const amenitiesList = [["wifi", "kitchen"], ["wifi", "balcony"], ["kitchen", "washer"], ["wifi", "pool"], ["air conditioning", "wifi"]];
            const bedrooms = [1, 2, 3];
            const randomIdx = () => Math.floor(Math.random() * 5);

            const property = {
                name: propertyNames[randomIdx()],
                original_price: 100 + Math.floor(Math.random() * 100),
                amenities: amenitiesList[randomIdx()],
                bedrooms: bedrooms[Math.floor(Math.random() * bedrooms.length)],
                location: {
                    city: cities[randomIdx()],
                    country: countries[randomIdx()]
                }
            };

            // Step 2: Generate random user and preferences
            const userId = "user" + Math.floor(Math.random() * 10000);
            const userPrefs = {
                amenities: property.amenities,
                price_max: property.original_price * 0.6,
                bedrooms: property.bedrooms
            };

            // Step 3: Add property
            let resp = await fetch(`${BASE}/properties/add`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(property)
            });
            const addPropResult = await resp.json();

            // Step 4: Register preferences
            resp = await fetch(`${BASE}/users/preferences`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ user_id: userId, preferences: userPrefs })
            });
            const regPrefsResult = await resp.json();

            // Step 5: Find matches
            resp = await fetch(`${BASE}/properties/match/${userId}`);
            const matchesResult = await resp.json();

            // Step 6: Book stay (if matches exist)
            let bookingResult = {};
            let revealResult = {};
            if (matchesResult.matches && matchesResult.matches.length > 0) {
                const propertyId = matchesResult.matches[0].id;
                const today = new Date();
                const checkIn = today.toISOString().slice(0,10);
                const checkOut = new Date(today.getTime() + 4*24*60*60*1000).toISOString().slice(0,10);

                resp = await fetch(`${BASE}/bookings/create`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        user_id: userId,
                        property_id: propertyId,
                        check_in: checkIn,
                        check_out: checkOut
                    })
                });
                bookingResult = await resp.json();

                // Step 7: Reveal location
                if (bookingResult.booking_id) {
                    resp = await fetch(`${BASE}/bookings/reveal/${bookingResult.booking_id}`);
                    revealResult = await resp.json();
                }
            }

            // Step 8: Display results
            resultDiv.innerHTML = `
                <b>Property Added:</b><br><pre>${JSON.stringify(property, null, 2)}</pre>
                <b>User Preferences Registered:</b><br><pre>${JSON.stringify({user_id: userId, preferences: userPrefs}, null, 2)}</pre>
                <b>Matches Found:</b><br><pre>${JSON.stringify(matchesResult.matches, null, 2)}</pre>
                <b>Booking Result:</b><br><pre>${JSON.stringify(bookingResult, null, 2)}</pre>
                <b>Reveal Location:</b><br><pre>${JSON.stringify(revealResult, null, 2)}</pre>
            `;
        };
    </script>
</body>
</html>